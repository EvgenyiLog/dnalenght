<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
<meta charset="UTF-8">
<title>FRF DNA Analyzer</title>
<script src="/static/js/chart.umd.js"></script>
<script src="/static/js/html2canvas.min.js"></script>
<script src="/static/js/jspdf.umd.min.js"></script>
<style>
:root {
    --bg: #f0f2f5;
    --card: #ffffff;
    --text: #333;
    --border: #ccc;
    --accent: #007bff;
}
[data-theme="dark"] {
    --bg: #18191a;
    --card: #242526;
    --text: #e4e6eb;
    --border: #3e4042;
    --accent: #2d88ff;
}
body {
    font-family: Segoe UI, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin:0; padding:20px;
    transition:0.3s;
}
.container {
    max-width:1400px; margin:auto;
    background: var(--card);
    padding:20px; border-radius:12px;
}
.folder-input { display:flex; gap:10px; margin-bottom:20px; align-items:center; }

/* –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
.input-wide {
    width: 90%; /* –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ */
    padding:8px;
    border-radius:5px;
    border:1px solid var(--border);
}

button { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; color:white; }
.scan-btn { background: var(--accent); }
#analyzeBtn { background:#28a745; }
#reportBtn { background:#6c757d; }
#themeBtn { background:#ffc107; color:#333; width: 10%; }

.main-layout { display:grid; grid-template-columns:350px 1fr; gap:20px; }
.file-list { height:240px; overflow-y:auto; border:1px solid var(--border); border-radius:6px; }
.file-item { padding:8px; cursor:pointer; border-bottom:1px solid var(--border); }
.file-item.active { background: var(--accent); color:white; }
.canvas-container { height:320px; margin-bottom:20px; }
#dataTable { width:100%; border-collapse:collapse; margin-top:10px; }
#dataTable th, #dataTable td { border:1px solid var(--border); padding:5px; text-align:center; font-size:12px; }
#dataTable th { background: var(--accent); color:white; }
</style>
</head>
<body>
<div class="container">
<h2>üß¨ Signal Processor</h2>

<!-- –í–≤–æ–¥ –ø–∞–ø–∫–∏ -->
<div class="folder-input">
<input id="pathInput" class="input-wide" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ">
<button class="scan-btn">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
</div>

<!-- –í–≤–æ–¥ –∏–º–µ–Ω–∏ –æ—Ç—á—ë—Ç–∞ –∏ –∫–Ω–æ–ø–∫–∏ -->
<div class="folder-input">
<input id="reportName" class="input-wide" type="text" placeholder="–ò–º—è –æ—Ç—á—ë—Ç–∞ PDF">
<button id="analyzeBtn">–ê–Ω–∞–ª–∏–∑</button>
<button id="reportBtn">–û—Ç—á—ë—Ç</button>
<button id="themeBtn">üåô / ‚òÄÔ∏è –¢–µ–º–∞</button>
</div>

<div class="main-layout">
<aside>
<h3>Leader</h3>
<div id="listKeyword" class="file-list"></div>

<h3>Genlib (Ref)</h3>
<div id="listOther" class="file-list"></div>
</aside>

<main>
<div class="canvas-container">
<canvas id="chartTop"></canvas>
</div>
<div class="canvas-container">
<canvas id="chartBottom"></canvas>
</div>

<table id="dataTable">
<thead>
<tr>
<th>Index</th>
<th>Raw</th>
<th>Corrected</th>
<th>–§–∞–π–ª</th>
</tr>
</thead>
<tbody>
<tr><td colspan="4" style="color:#888;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</td></tr>
</tbody>
</table>
</main>
</div>
</div>

<script>
let chartTop=null;
let chartBottom=null;
let pathMap={};
let selectedTopFile=null;
let selectedBottomFile=null;

/* ---------- –°–ö–ê–ù ---------- */
document.querySelector('.scan-btn').onclick = async () => {
    const fd = new FormData();
    fd.append("folder_path", pathInput.value);
    const res = await fetch("/scan-folder/", { method:"POST", body:fd });
    const data = await res.json();

    pathMap={};
    [...data.keyword_files, ...data.other_files].forEach(f => pathMap[f.title]=f.path);

    renderUIList("listKeyword", data.keyword_files,"top");
    renderUIList("listOther", data.other_files,"bottom");
};

/* ---------- –°–ü–ò–°–û–ö –§–ê–ô–õ–û–í ---------- */
function renderUIList(id, files, position){
    const el=document.getElementById(id);
    el.innerHTML=files.length? '' : '<div style="padding:10px;color:#888;">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>';

    files.forEach(fileObj=>{
        const item=document.createElement('div');
        item.className='file-item';
        const displayName=fileObj.title || fileObj.path || JSON.stringify(fileObj);
        item.textContent=displayName;

        item.addEventListener('click',()=>{
            el.querySelectorAll('.file-item').forEach(i=>i.classList.remove('active'));
            item.classList.add('active');

            const fullPath=fileObj.path || pathMap[displayName];
            if(position==="top"){ selectedTopFile=fullPath; loadAndDraw(fullPath,"top"); }
            else{ selectedBottomFile=fullPath; loadAndDraw(fullPath,"bottom"); }
        });
        el.appendChild(item);
    });
}

/* ---------- –ó–ê–ì–†–£–ó–ö–ê –ò –ü–û–°–¢–†–û–ï–ù–ò–ï –ì–†–ê–§–ò–ö–ê ---------- */
async function loadAndDraw(fullPath, position){
    const fd = new FormData();
    fd.append("full_path", fullPath);
    const res = await fetch("/process-by-path/", { method:"POST", body:fd });
    const data = await res.json();
    drawChart(data, position);
    fillTable(data, fullPath);
}

/* ---------- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ ---------- */
function drawChart(data, position){
    const canvas = position==="top"? document.getElementById("chartTop") : document.getElementById("chartBottom");
    if(position==="top" && chartTop) chartTop.destroy();
    if(position==="bottom" && chartBottom) chartBottom.destroy();

    const chart = new Chart(canvas,{
        type:"line",
        data:{
            labels:data.labels,
            datasets:[
                {label:"Raw", data:data.raw, borderColor:"#ff6384", pointRadius:0},
                {label:"Corrected", data:data.corrected, borderColor:"#4bc0c0", pointRadius:0}
            ]
        },
        options:{responsive:true, maintainAspectRatio:false}
    });

    if(position==="top") chartTop=chart;
    else chartBottom=chart;
}

/* ---------- –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ ---------- */
function fillTable(data, filename){
    const tbody=document.querySelector("#dataTable tbody");
    tbody.innerHTML="";
    const N=Math.min(data.labels.length,50); // –ø–µ—Ä–≤—ã–µ 50 —Ç–æ—á–µ–∫
    for(let i=0;i<N;i++){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${data.labels[i]}</td><td>${data.raw[i].toFixed(4)}</td><td>${data.corrected[i].toFixed(4)}</td><td>${filename}</td>`;
        tbody.appendChild(tr);
    }
}

/* ---------- –ö–ù–û–ü–ö–ò ---------- */
document.getElementById("analyzeBtn").onclick=()=>{
    const reportName=document.getElementById("reportName").value;
    console.log("–ê–Ω–∞–ª–∏–∑ –æ—Ç—á—ë—Ç–∞ –¥–ª—è:", reportName);
    if(selectedTopFile) loadAndDraw(selectedTopFile,"top");
    if(selectedBottomFile) loadAndDraw(selectedBottomFile,"bottom");
};

/* ---------- –ö–ù–û–ü–ö–ê PDF ---------- */
document.getElementById("reportBtn").onclick = async () => {
    const { jsPDF } = window.jspdf;
    const pdfName = document.getElementById("reportName").value || "report";
    const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'px',
        format: 'a4'
    });

    const margin = 20;
    let y = margin;

    // –ú–∞—Å—Å–∏–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë)
    const elements = [
        document.getElementById("chartTop"),
        document.getElementById("chartBottom")
    ];

    for (const el of elements) {
        const canvas = await html2canvas(el);
        const imgData = canvas.toDataURL("image/png");
        const pdfWidth = pdf.internal.pageSize.getWidth() - 2*margin;
        const pdfHeight = 200; // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        pdf.addImage(imgData, "PNG", margin, y, pdfWidth, pdfHeight);
        y += pdfHeight + 10;
    }

    // –¢–∞–±–ª–∏—Ü–∞
    const tableCanvas = await html2canvas(document.getElementById("dataTable"));
    const tableImg = tableCanvas.toDataURL("image/png");
    const tableHeight = tableCanvas.height * ((pdf.internal.pageSize.getWidth() - 2*margin)/tableCanvas.width);
    pdf.addImage(tableImg, "PNG", margin, y, pdf.internal.pageSize.getWidth() - 2*margin, tableHeight);

    pdf.save(pdfName + ".pdf");
};

/* ---------- –¢–ï–ú–ê ---------- */
document.getElementById("themeBtn").onclick=()=>{
    const html=document.documentElement;
    const next=html.getAttribute("data-theme")==="light"? "dark":"light";
    html.setAttribute("data-theme", next);
    const gridColor=next==="dark"? "#333":"#eee";
    [chartTop,chartBottom].forEach(c=>{
        if(c){
            c.options.scales.x.grid.color=gridColor;
            c.options.scales.y.grid.color=gridColor;
            c.update();
        }
    });
};
</script>
</body>
</html>