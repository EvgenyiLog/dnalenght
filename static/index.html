<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
<meta charset="UTF-8">
<title>FRF DNA Analyzer</title>
<script src="/static/js/chart.umd.js"></script>
<script src="/static/js/jspdf.umd.min.js"></script>
<script src="/static/fonts/DejaVuSans.base64.js"></script>
<style>
:root {
    --bg: #f0f2f5; --card: #ffffff; --text: #333; --border: #ccc; --accent: #007bff;
}
[data-theme="dark"] { --bg: #18191a; --card: #242526; --text: #e4e6eb; --border: #3e4042; --accent: #2d88ff; }
body { font-family: Segoe UI, sans-serif; background: var(--bg); color: var(--text); margin:0; padding:20px; transition:0.3s; }
.container { max-width:1400px; margin:auto; background: var(--card); padding:20px; border-radius:12px; }
.folder-input { display:flex; gap:10px; margin-bottom:20px; align-items:center; }
.input-wide { width: 90%; padding:8px; border-radius:5px; border:1px solid var(--border); }
button { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; color:white; }
.scan-btn { background: var(--accent); }
#analyzeBtn { background:#28a745; }
#reportBtn { background:#6c757d; }
#themeBtn { background:#ffc107; color:#333; width: 10%; }

.main-layout { display:grid; grid-template-columns:350px 1fr; gap:20px; }
.file-list { height:240px; overflow-y:auto; border:1px solid var(--border); border-radius:6px; }
.file-item { padding:8px; cursor:pointer; border-bottom:1px solid var(--border); }
.file-item.active { background: var(--accent); color:white; }
.canvas-container { height:320px; margin-bottom:20px; }
#dataTable { width:100%; border-collapse:collapse; margin-top:10px; }
#dataTable th, #dataTable td { border:1px solid var(--border); padding:5px; text-align:center; font-size:12px; }
#dataTable th { background: var(--accent); color:white; }
</style>
</head>
<body>
<div class="container">
<h2>üß¨ Signal Processor</h2>

<div class="folder-input">
<input id="pathInput" class="input-wide" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ">
<button class="scan-btn">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
</div>

<div class="folder-input">
<input id="reportName" class="input-wide" type="text" placeholder="–ò–º—è –æ—Ç—á—ë—Ç–∞ PDF">
<button id="analyzeBtn">–ê–Ω–∞–ª–∏–∑</button>
<button id="reportBtn">–û—Ç—á—ë—Ç</button>
<button id="themeBtn">üåô / ‚òÄÔ∏è –¢–µ–º–∞</button>
</div>

<div class="main-layout">
<aside>
<h3>Leader</h3>
<div id="listKeyword" class="file-list"></div>

<h3>Genlib (Ref)</h3>
<div id="listOther" class="file-list"></div>
</aside>

<main>
<div class="canvas-container">
<canvas id="chartTop"></canvas>
</div>
<div class="canvas-container">
<canvas id="chartBottom"></canvas>
</div>

<table id="dataTable">
<thead>
<tr>
<th>Index</th>
<th>Top Raw</th>
<th>Top Corrected</th>
<th>Bottom Raw</th>
<th>Bottom Corrected</th>
</tr>
</thead>
<tbody>
<tr><td colspan="5" style="color:#888;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</td></tr>
</tbody>
</table>
</main>
</div>
</div>

<script>
let chartTop=null;
let chartBottom=null;
let pathMap={};
let selectedTopFile=null;
let selectedBottomFile=null;

/* ---------- –°–ö–ê–ù ---------- */
document.querySelector('.scan-btn').onclick = async () => {
    const fd = new FormData();
    fd.append("folder_path", pathInput.value);
    const res = await fetch("/scan-folder/", { method:"POST", body:fd });
    const data = await res.json();

    pathMap={};
    [...data.keyword_files, ...data.other_files].forEach(f => pathMap[f.title]=f.path);

    renderUIList("listKeyword", data.keyword_files,"top");
    renderUIList("listOther", data.other_files,"bottom");
};

/* ---------- –°–ü–ò–°–û–ö –§–ê–ô–õ–û–í ---------- */
function renderUIList(id, files, position){
    const el=document.getElementById(id);
    el.innerHTML=files.length? '' : '<div style="padding:10px;color:#888;">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>';

    files.forEach(fileObj=>{
        const item=document.createElement('div');
        item.className='file-item';
        const displayName=fileObj.title || fileObj.path || JSON.stringify(fileObj);
        item.textContent=displayName;

        item.addEventListener('click',()=>{
            el.querySelectorAll('.file-item').forEach(i=>i.classList.remove('active'));
            item.classList.add('active');

            const fullPath=fileObj.path || pathMap[displayName];
            if(position==="top"){ selectedTopFile=fullPath; loadPairAnalysis(); }
            else{ selectedBottomFile=fullPath; loadPairAnalysis(); }
        });
        el.appendChild(item);
    });
}

/* ---------- –ó–ê–ì–†–£–ó–ö–ê –ü–ê–†–´ –§–ê–ô–õ–û–í ---------- */
async function loadPairAnalysis(){
    if(!selectedTopFile || !selectedBottomFile) return;
    const fd=new FormData();
    fd.append("top_path", selectedTopFile);
    fd.append("bottom_path", selectedBottomFile);

    const res=await fetch("/analyze-pair/", { method:"POST", body:fd });
    const data=await res.json();

    drawChartPair(data.top, "chartTop");
    drawChartPair(data.bottom, "chartBottom");
    fillTable(data.table);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º extra –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è PDF
    window.extraTop = data.extra_top;
    window.extraBottom = data.extra_bottom;

    // **–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è PDF**
    window.tableData = data.table;  // <<< –≤–æ—Ç –∫–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç
}

/* ---------- –ü–û–°–¢–†–û–ï–ù–ò–ï –ì–†–ê–§–ò–ö–ê –° FILL/VLINES/HLINES ---------- */
function drawChartPair(data, canvasId){
    const canvas=document.getElementById(canvasId);
    if(canvasId==="chartTop" && chartTop) chartTop.destroy();
    if(canvasId==="chartBottom" && chartBottom) chartBottom.destroy();

    const datasets=[
        {label:"Raw", data:data.raw, borderColor:"#ff6384", pointRadius:0},
        {label:"Corrected", data:data.corrected, borderColor:"#4bc0c0", pointRadius:0}
    ];

    if(data.fill_upper && data.fill_lower){
        datasets.push({
            label:"Fill",
            data:data.fill_upper,
            borderColor:"rgba(0,0,0,0)",
            backgroundColor:"rgba(0,128,0,0.1)",
            fill:"+1"
        });
    }

    if(data.vlines){
        data.vlines.forEach(x=>{
            datasets.push({
                label:"VLine", data:Array(data.labels.length).fill(null), borderColor:"#000000",
                borderDash:[5,5], pointRadius:0
            });
        });
    }

    if(canvasId==="chartTop") chartTop=new Chart(canvas,{type:"line", data:{labels:data.labels, datasets:datasets}, options:{responsive:true, maintainAspectRatio:false}});
    else chartBottom=new Chart(canvas,{type:"line", data:{labels:data.labels, datasets:datasets}, options:{responsive:true, maintainAspectRatio:false}});
}

/* ---------- –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ ---------- */
function fillTable(tableData){
    const tbody = document.querySelector("#dataTable tbody");
    const thead = document.querySelector("#dataTable thead");

    tbody.innerHTML = "";

    if(!tableData || !tableData.length){
        tbody.innerHTML = '<tr><td colspan="10" style="color:#888;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    // --- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ---
    const colNames = Object.keys(tableData[0]);
    thead.innerHTML = "<tr>" + colNames.map(c=>`<th>${c}</th>`).join("") + "</tr>";

    // --- –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç—Ä–æ–∫–∏ ---
    tableData.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = colNames.map(c => `<td>${row[c] !== undefined ? row[c] : ""}</td>`).join("");
        tbody.appendChild(tr);
    });
}
/* ---------- –®–†–ò–§–¢ PDF ---------- */
function initPdfFont(pdf){
    pdf.addFileToVFS("app/static/fonts/DejaVuSans.ttf", window.DejaVuSansBase64);
    pdf.addFont("DejaVuSans.ttf", "DejaVuSans", "normal");
    pdf.setFont("DejaVuSans");
}


/* ---------- –ö–ù–û–ü–ö–ê PDF ---------- */
document.getElementById("reportBtn").onclick = async () => {
    if (!window.extraTop || !window.extraBottom || !window.tableData) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        return;
    }

    const reportName = document.getElementById("reportName").value || "report";
    const { jsPDF } = window.jspdf;

    // –°–æ–∑–¥–∞—ë–º PDF –≤ –∞–ª—å–±–æ–º–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    const pdf = new jsPDF("l", "mm", "a4");

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ canvas –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏
    function addCanvasToPdf(canvas, yPos) {
        const imgData = canvas.toDataURL("image/png");
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        // –ü–æ–¥–≥–æ–Ω—è–µ–º —à–∏—Ä–∏–Ω—É –ø–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
        const ratio = canvas.width / canvas.height;
        const imgWidth = pageWidth - 20; // –æ—Ç—Å—Ç—É–ø 10 –º–º —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
        const imgHeight = imgWidth / ratio;
        pdf.addImage(imgData, "PNG", 10, yPos, imgWidth, imgHeight);
    }

    // --- Top –≥—Ä–∞—Ñ–∏–∫ ---
    initPdfFont(pdf);
    pdf.setFontSize(14);
    pdf.text("Top Graph", 10, 10);
    addCanvasToPdf(chartTop.canvas, 15);

    // --- Bottom –≥—Ä–∞—Ñ–∏–∫ ---
    pdf.addPage();
    pdf.text("Bottom Graph", 10, 10);
    addCanvasToPdf(chartBottom.canvas, 15);

    // --- Extra –≥—Ä–∞—Ñ–∏–∫ ---
    pdf.addPage();
    pdf.text("Extra Graph", 10, 10);

    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = 1200;
    tempCanvas.height = 300;
    new Chart(tempCanvas, {
        type: "line",
        data: {
            labels: window.extraTop.labels,
            datasets: [{ label: "Extra Raw", data: window.extraTop.raw, borderColor: "#ff6384", pointRadius: 2 }]
        },
        options: { responsive: false, animation: false, maintainAspectRatio: false }
    });
    addCanvasToPdf(tempCanvas, 15);

    // --- –¢–∞–±–ª–∏—Ü–∞ ---
    pdf.addPage();
    pdf.setFontSize(10);

    const tableData = window.tableData;
    if (tableData && tableData.length) {
        const colNames = Object.keys(tableData[0]);
        const colWidth = (pdf.internal.pageSize.getWidth() - 20) / colNames.length;
        let startY = 20;

        // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        pdf.setFont("helvetica", "bold");
        colNames.forEach((col, i) => pdf.text(String(col), 10 + i * colWidth, startY));
        startY += 7;

        pdf.setFont("helvetica", "normal");

        // –°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        tableData.forEach((row, rowIndex) => {
            if (startY > pdf.internal.pageSize.getHeight() - 15) {
                pdf.addPage();
                startY = 20;
                colNames.forEach((col, i) => pdf.text(String(col), 10 + i * colWidth, startY));
                startY += 7;
            }
            colNames.forEach((col, i) => {
                let text = row[col] !== undefined ? String(row[col]) : "";
                pdf.text(text, 10 + i * colWidth, startY);
            });
            startY += 7;
        });
    } else {
        pdf.text("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö", 10, 20);
    }

    pdf.save(reportName + ".pdf");
};

/* ---------- –¢–ï–ú–ê ---------- */
document.getElementById("themeBtn").onclick=()=>{
    const html=document.documentElement;
    const next=html.getAttribute("data-theme")==="light"? "dark":"light";
    html.setAttribute("data-theme", next);
};
</script>
</body>
</html>